name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
          - os: ubuntu-latest
            platform: android
            arch: armv7
            android_abi: armeabi-v7a
          - os: ubuntu-latest
            platform: android
            arch: aarch64
            android_abi: arm64-v8a
          - os: windows-latest
            platform: windows
            arch: x86_64
          - os: macos-latest
            platform: darwin
            arch: x86_64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux' && matrix.platform == 'linux'
      run: |
        sudo apt-get update
        # Install build essentials and jsoncpp
        sudo apt-get install -y cmake build-essential libjsoncpp-dev
        
        # Try to install kodi-pvr-dev (if available) otherwise fall back to kodi-dev
        if apt-cache show kodi-pvr-dev >/dev/null 2>&1; then
          sudo apt-get install -y kodi-pvr-dev
        elif apt-cache show kodi-dev >/dev/null 2>&1; then
          sudo apt-get install -y kodi-dev
        else
          echo "Warning: kodi dev packages not available via apt"
          echo "Build may fail if Kodi headers are not found"
        fi

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake jsoncpp

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        
        # Install vcpkg and jsoncpp
        git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
        C:\vcpkg\bootstrap-vcpkg.bat
        C:\vcpkg\vcpkg integrate install
        C:\vcpkg\vcpkg install jsoncpp:x64-windows
        
        # Add vcpkg toolchain to environment
        echo "CMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake" >> $env:GITHUB_ENV

    - name: Setup Android NDK
      if: matrix.platform == 'android'
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c

    - name: Install Android dependencies and build JsonCpp
      if: matrix.platform == 'android'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential git
        
        # Build JsonCpp for Android
        git clone --depth=1 https://github.com/open-source-parsers/jsoncpp.git
        cd jsoncpp
        mkdir build
        cd build
        
        # Set up Android NDK toolchain
        if [ -n "$ANDROID_NDK_HOME" ]; then
          TOOLCHAIN_FILE="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake"
        elif [ -n "$ANDROID_NDK_ROOT" ]; then
          TOOLCHAIN_FILE="$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake"
        else
          echo "Error: ANDROID_NDK_HOME/ANDROID_NDK_ROOT not set"
          exit 1
        fi
        
        # Build JsonCpp for Android
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN_FILE" \
          -DANDROID_ABI=${{ matrix.android_abi }} \
          -DANDROID_PLATFORM=android-21 \
          -DCMAKE_BUILD_TYPE=Release \
          -DJSONCPP_WITH_TESTS=OFF \
          -DJSONCPP_WITH_POST_BUILD_UNITTEST=OFF \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_INSTALL_PREFIX=$PWD/../../jsoncpp-android
        
        make -j$(nproc)
        make install
        cd ../..

    - name: Install Kodi addon development headers
      if: matrix.platform == 'android'
      run: |
        # For Android cross-compilation, we only need Kodi's C++ API headers, not a full SDK.
        # Clone kodi-dev-kit (minimal headers needed for addon development)
        git clone --depth=1 --branch Omega https://github.com/xbmc/xbmc.git kodi-source
        
        # The addon needs to find KodiConfig.cmake, but for cross-compilation we can use a minimal approach:
        # Just provide the headers. The addon CMakeLists.txt uses build_addon() which is designed for this.
        # We'll point CMAKE_PREFIX_PATH to a location with headers.
        mkdir -p kodi-dev/include/kodi
        cp -r kodi-source/xbmc/addons/kodi-dev-kit/include/kodi/* kodi-dev/include/kodi/
        
        # For the find_package(Kodi) to work, we need a minimal KodiConfig.cmake
        mkdir -p kodi-dev/lib/cmake/kodi
        cat > kodi-dev/lib/cmake/kodi/KodiConfig.cmake << 'EOF'
        # Minimal Kodi config for cross-compilation of addons
        set(KODI_INCLUDE_DIR "${CMAKE_CURRENT_LIST_DIR}/../../../include")
        set(KODI_LIB_DIR "${CMAKE_CURRENT_LIST_DIR}/../../../lib")
        include_directories(${KODI_INCLUDE_DIR})
        
        # Provide the build_addon macro (simplified version for addon builds)
        macro(build_addon target prefix libs)
          add_library(${target} SHARED ${${prefix}_SOURCES})
          target_link_libraries(${target} ${${libs}})
          set_target_properties(${target} PROPERTIES PREFIX "")
          if(ANDROID)
            set_target_properties(${target} PROPERTIES PREFIX "lib")
          endif()
        endmacro()
        EOF

    - name: Build addon
      if: matrix.platform != 'android'
      shell: bash
      run: |
        mkdir -p build
        cd build
        
        # Configure CMake with platform-specific options
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="${CMAKE_TOOLCHAIN_FILE}"
        else
          cmake .. -DCMAKE_BUILD_TYPE=Release
        fi
        
        cmake --build . --config Release

    - name: Build addon for Android (${{ matrix.arch }})
      if: matrix.platform == 'android'
      run: |
        mkdir -p build
        cd build
        
        # Set up Android NDK toolchain
        if [ -n "$ANDROID_NDK_HOME" ]; then
          TOOLCHAIN_FILE="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake"
        elif [ -n "$ANDROID_NDK_ROOT" ]; then
          TOOLCHAIN_FILE="$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake"
        else
          echo "Error: ANDROID_NDK_HOME/ANDROID_NDK_ROOT not set"
          exit 1
        fi
        
        # Cross-compile for Android with Kodi headers and JsonCpp
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN_FILE" \
          -DANDROID_ABI=${{ matrix.android_abi }} \
          -DANDROID_PLATFORM=android-21 \
          -DCMAKE_PREFIX_PATH="$PWD/../kodi-dev;$PWD/../jsoncpp-android" \
          -DCMAKE_FIND_ROOT_PATH="$PWD/../kodi-dev;$PWD/../jsoncpp-android"
        
        cmake --build . --config Release

    - name: Package addon
      shell: bash
      run: |
        mkdir -p package/pvr.jellyfin
        
        # Copy built library from build directory
        if [ "${{ matrix.platform }}" = "windows" ]; then
          cp build/Release/pvr.jellyfin.dll package/pvr.jellyfin/ || cp build/pvr.jellyfin.dll package/pvr.jellyfin/
        elif [ "${{ matrix.platform }}" = "darwin" ]; then
          cp build/pvr.jellyfin.dylib package/pvr.jellyfin/ || cp build/libpvr.jellyfin.dylib package/pvr.jellyfin/
        else
          cp build/pvr.jellyfin.so package/pvr.jellyfin/ || cp build/libpvr.jellyfin.so package/pvr.jellyfin/
        fi
        
        # Copy addon metadata and resources
        cp -r resources package/pvr.jellyfin/
        cp addon.xml.in package/pvr.jellyfin/addon.xml
        cp LICENSE package/pvr.jellyfin/
        cp README.md package/pvr.jellyfin/
        
        # Create zip
        cd package
        if command -v zip &> /dev/null; then
          zip -r ../pvr.jellyfin-${{ matrix.platform }}-${{ matrix.arch }}.zip pvr.jellyfin
        else
          # Windows fallback using PowerShell
          powershell Compress-Archive -Path pvr.jellyfin -DestinationPath ../pvr.jellyfin-${{ matrix.platform }}-${{ matrix.arch }}.zip
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pvr.jellyfin-${{ matrix.platform }}-${{ matrix.arch }}
        path: pvr.jellyfin-${{ matrix.platform }}-${{ matrix.arch }}.zip

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-repository:
    needs: create-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: Checkout main branch (for scripts and repository addon)
      uses: actions/checkout@v4
      with:
        path: main-repo

    - name: Checkout or create repo branch (addon repository)
      uses: actions/checkout@v4
      with:
        ref: repo
        path: addon-repo
      continue-on-error: true
      
    - name: Initialize repo branch if it doesn't exist
      run: |
        if [ ! -d "addon-repo/.git" ]; then
          echo "repo branch doesn't exist, creating it..."
          mkdir -p addon-repo
          cd addon-repo
          git init
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git checkout -b repo
          echo "# Jellyfin PVR Addon Repository" > README.md
          echo "This branch contains the Kodi addon repository files." >> README.md
          git add README.md
          git commit -m "Initialize repo branch"
          git push -u origin repo
        fi

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Package repository addon
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "Packaging repository addon version $VERSION"
        
        # Update version in repository addon.xml
        sed -i "s/version=\"[^\"]*\"/version=\"$VERSION\"/" main-repo/repository/repository.jellyfin.pvr/addon.xml
        
        # Create repository addon zip
        cd main-repo/repository
        zip -r ../../addon-repo/repository.jellyfin.pvr.zip repository.jellyfin.pvr
        
    - name: Update addon repository
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "Updating addon repository for version $VERSION"
        
        # Create pvr.jellyfin directory in repository
        mkdir -p addon-repo/pvr.jellyfin
        
        # Copy all built addon zips to the repository
        for artifact_dir in artifacts/*/; do
          if [ -d "$artifact_dir" ]; then
            cp -v "$artifact_dir"*.zip addon-repo/pvr.jellyfin/ || true
          fi
        done
        
        # Copy and run the repository update script
        cp main-repo/scripts/update_repo.py addon-repo/
        cd addon-repo
        python3 update_repo.py
        
        # Commit and push changes
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update repository with version $VERSION"
          git push
        fi
