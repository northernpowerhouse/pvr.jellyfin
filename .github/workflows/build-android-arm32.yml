name: Build Android (armeabi-v7a) & Publish

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      app_id: pvr.jellyfin
      ANDROID_ARCH: arm
      ANDROID_CPU: armeabi-v7a
    steps:
      - name: Checkout addon repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.app_id }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and cache Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.app_id }}
          file: ${{ env.app_id }}/Dockerfile.android-build
          push: false
          load: true
          tags: kodi-android-builder:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set version
        id: set_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.${GITHUB_RUN_NUMBER}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Selected VERSION=$VERSION"

      - name: Checkout Kodi repository (for addon build)
        uses: actions/checkout@v4
        with:
          repository: xbmc/xbmc
          ref: Omega
          path: xbmc

      - name: Prepare addon for Kodi build system
        run: |
          mkdir -p xbmc/cmake/addons/addons/${{ env.app_id }}
          echo "${{ env.app_id }} file://$(pwd)/${{ env.app_id }}" > xbmc/cmake/addons/addons/${{ env.app_id }}/${{ env.app_id }}.txt

      - name: Build addon using Docker image
        run: |
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            -e ADDON_SRC_PREFIX=/workspace \
            kodi-android-builder:latest \
            bash -c "
              cd /workspace/xbmc &&
              make -C tools/depends/target/binary-addons ADDONS='${{ env.app_id }}' \
                ADDON_SRC_PREFIX=/workspace \
                PREFIX=/opt/xbmc-depends \
                CROSS_COMPILING=yes
            "

      - name: Locate and prepare addon package
        run: |
          set -euo pipefail
          # Find the built addon zip
          ADDON_ZIP=$(find xbmc -name "${{ env.app_id }}-*.zip" -print -quit || true)
          if [ -z "$ADDON_ZIP" ]; then
            echo "Addon zip not found. Searching..." >&2
            find xbmc -name "*.zip" -type f >&2
            exit 1
          fi
          echo "Found addon package: $ADDON_ZIP"
          cp "$ADDON_ZIP" "${{ github.workspace }}/${{ env.app_id }}-${VERSION}.zip"
          ls -lh "${{ github.workspace }}/${{ env.app_id }}-${VERSION}.zip"

      - name: Create repository package
        run: |
          set -euo pipefail
          cd ${{ env.app_id }}
          chmod +x scripts/package_repo.sh
          ./scripts/package_repo.sh "${VERSION}"
          mv "repository.jellyfin.pvr-${VERSION}.zip" "${{ github.workspace }}/"
          ls -lh "${{ github.workspace }}/repository.jellyfin.pvr-${VERSION}.zip"

      - name: Create release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }} (Android armeabi-v7a)
          body: |
            Android build for Kodi Omega (armeabi-v7a)
            
            **Installation:**
            1. Install `repository.jellyfin.pvr-${{ env.VERSION }}.zip` in Kodi
            2. Install the addon from the repository
            
            Or install `pvr.jellyfin-${{ env.VERSION }}.zip` directly
          files: |
            pvr.jellyfin-${{ env.VERSION }}.zip
            repository.jellyfin.pvr-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
