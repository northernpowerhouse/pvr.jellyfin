name: Build Android (armeabi-v7a) & Publish

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      NDK_VERSION: r25b
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set version
        id: set_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="0.0.${GITHUB_RUN_NUMBER}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Selected VERSION=$VERSION"

      - name: Install required packages
        run: sudo apt-get update && sudo apt-get install -y unzip zip cmake build-essential wget

      - name: Cache Android NDK
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.ndk-cache
          key: ndk-${{ env.NDK_VERSION }}-${{ runner.os }}

      - name: Download Android NDK (if not cached)
        run: |
          set -euo pipefail
          echo "NDK_VERSION=${NDK_VERSION}"
          # If previously cached to the expected path, use it
          CACHED_DIR="$HOME/android-ndk-${NDK_VERSION}"
          if [ -d "$CACHED_DIR" ]; then
            echo "Using cached NDK at $CACHED_DIR"
          else
            echo "Downloading Android NDK ${NDK_VERSION}..."
            curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
            unzip -q ndk.zip -d $HOME
            echo "Downloaded NDK to $CACHED_DIR"
          fi
          echo "ANDROID_NDK=$HOME/android-ndk-${NDK_VERSION}" >> $GITHUB_ENV

      - name: Configure and build for armeabi-v7a
        run: |
          set -euo pipefail
          echo "Using ANDROID_NDK=$ANDROID_NDK"
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=armeabi-v7a \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release -j$(nproc)

      - name: Locate built library
        id: findlib
        run: |
          set -euo pipefail
          # Try to find the compiled shared object (the name may vary depending on CMake/Kodi macros)
          LIB=$(find build -type f -name "*pvr*.so" -print -quit || true)
          if [ -z "$LIB" ]; then
            echo "No built .so found; listing build/ for debugging:" >&2
            find build -maxdepth 4 -type f | sed -n '1,200p' >&2
            exit 1
          fi
          echo "Found built library: $LIB"
          echo "LIB_PATH=$LIB" >> $GITHUB_ENV

      - name: Create addon package (zip) and include built .so
        run: |
          set -euo pipefail
          VERSION=${VERSION}
          chmod +x scripts/package.sh
          ./scripts/package.sh "$VERSION"

          # Ensure package directory exists (script/package.sh leaves package/)
          if [ ! -d "package/pvr.jellyfin" ]; then
            echo "Expected package/pvr.jellyfin directory not found" >&2
            ls -la package || true
            exit 1
          fi

          # Copy the compiled .so into the package so the addon zip contains the binary
          if [ -f "$LIB_PATH" ]; then
            echo "Copying $LIB_PATH -> package/pvr.jellyfin/pvr.jellyfin.so"
            cp "$LIB_PATH" package/pvr.jellyfin/pvr.jellyfin.so
          else
            echo "Built library $LIB_PATH not found" >&2
            exit 1
          fi

          # Recreate the addon zip so it includes the .so
          rm -f "pvr.jellyfin-$VERSION.zip"
          cd package
          zip -r "../pvr.jellyfin-$VERSION.zip" pvr.jellyfin
          cd ..
          ls -lh "pvr.jellyfin-$VERSION.zip"

      - name: Create repository package
        run: |
          set -euo pipefail
          chmod +x scripts/package_repo.sh
          ./scripts/package_repo.sh "${VERSION}"
          ls -lh "repository.jellyfin.pvr-${VERSION}.zip"

      - name: Create release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          files: |
            pvr.jellyfin-${{ env.VERSION }}.zip
            repository.jellyfin.pvr-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
