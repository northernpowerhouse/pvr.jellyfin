name: Build Android (armeabi-v7a) & Publish

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      app_id: pvr.jellyfin
      ANDROID_ARCH: arm
      ANDROID_CPU: armeabi-v7a
    steps:
      - name: Checkout Kodi repository
        uses: actions/checkout@v4
        with:
          repository: xbmc/xbmc
          ref: Omega
          path: xbmc
          
      - name: Checkout addon repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.app_id }}

      - name: Set version
        id: set_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.${GITHUB_RUN_NUMBER}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Selected VERSION=$VERSION"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-11-jdk \
            automake autopoint bison build-essential ccache cmake curl default-jdk \
            gawk gdc gettext git-core gperf groovy libass-dev libasound2-dev \
            libavahi-client-dev libavahi-common-dev libbluetooth-dev libbluray-dev \
            libbz2-dev libcdio-dev libcec-dev libp8-platform-dev libcrossguid-dev \
            libcurl4-openssl-dev libcwiid-dev libdbus-1-dev libegl1-mesa-dev \
            libenca-dev libflac-dev libfontconfig-dev libfmt-dev libfreetype6-dev \
            libfribidi-dev libfstrcmp-dev libgcrypt-dev libgif-dev libgles2-mesa-dev \
            libglew-dev libglu1-mesa-dev libgnutls28-dev libgpg-error-dev \
            libiso9660-dev libjpeg-dev liblcms2-dev libltdl-dev liblzo2-dev \
            libmicrohttpd-dev libmariadb-dev libmariadb-dev-compat libnfs-dev \
            libogg-dev libomxil-bellagio-dev libpcre3-dev libplist-dev libpng-dev \
            libpulse-dev libshairplay-dev libsmbclient-dev libspdlog-dev \
            libsqlite3-dev libssl-dev libtag1-dev libtiff5-dev libtinyxml-dev \
            libtool libudev-dev libunistring-dev libva-dev libvdpau-dev libvorbis-dev \
            libxkbcommon-dev libxmu-dev libxrandr-dev libxslt1-dev libxt-dev \
            lsb-release meson nasm ninja-build python3-dev python3-pil python3-minimal \
            rapidjson-dev swig unzip uuid-dev zip zlib1g-dev

      - name: Set up Android build environment
        run: |
          cd xbmc/tools/depends
          ./bootstrap
          ./configure --host=${{ env.ANDROID_ARCH }}-linux-androideabi \
            --with-platform=android-${{ env.ANDROID_ARCH }} \
            --prefix=$(pwd)/android-${{ env.ANDROID_ARCH }}

      - name: Build Kodi dependencies for Android
        run: |
          cd xbmc/tools/depends
          make -j$(nproc)

      - name: Prepare addon for Kodi build system
        run: |
          mkdir -p xbmc/cmake/addons/addons/${{ env.app_id }}
          echo "${{ env.app_id }} file://$(pwd)/${{ env.app_id }}" > xbmc/cmake/addons/addons/${{ env.app_id }}/${{ env.app_id }}.txt

      - name: Build addon using Kodi build system
        run: |
          cd xbmc/cmake/addons
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DADDONS_TO_BUILD=${{ env.app_id }} \
            -DADDON_SRC_PREFIX=$(pwd)/../../../.. \
            -DCMAKE_TOOLCHAIN_FILE=$(pwd)/../../../tools/depends/target/Toolchain_binaddons.cmake \
            -DPLATFORM_DIR=$(pwd)/../../../tools/depends/target/android-${{ env.ANDROID_ARCH }} \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../../../addons \
            -DPACKAGE_ZIP=ON
          make -j$(nproc)

      - name: Locate and prepare addon package
        run: |
          set -euo pipefail
          # Find the built addon zip
          ADDON_ZIP=$(find xbmc -name "${{ env.app_id }}-*.zip" -print -quit || true)
          if [ -z "$ADDON_ZIP" ]; then
            echo "Addon zip not found. Searching..." >&2
            find xbmc -name "*.zip" -type f >&2
            exit 1
          fi
          echo "Found addon package: $ADDON_ZIP"
          cp "$ADDON_ZIP" "${{ github.workspace }}/${{ env.app_id }}-${VERSION}.zip"
          ls -lh "${{ github.workspace }}/${{ env.app_id }}-${VERSION}.zip"

      - name: Create repository package
        run: |
          set -euo pipefail
          cd ${{ env.app_id }}
          chmod +x scripts/package_repo.sh
          ./scripts/package_repo.sh "${VERSION}"
          mv "repository.jellyfin.pvr-${VERSION}.zip" "${{ github.workspace }}/"
          ls -lh "${{ github.workspace }}/repository.jellyfin.pvr-${VERSION}.zip"

      - name: Create release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }} (Android armeabi-v7a)
          body: |
            Android build for Kodi Omega (armeabi-v7a)
            
            **Installation:**
            1. Install `repository.jellyfin.pvr-${{ env.VERSION }}.zip` in Kodi
            2. Install the addon from the repository
            
            Or install `pvr.jellyfin-${{ env.VERSION }}.zip` directly
          files: |
            pvr.jellyfin-${{ env.VERSION }}.zip
            repository.jellyfin.pvr-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
