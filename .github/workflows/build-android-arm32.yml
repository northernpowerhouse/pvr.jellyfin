name: Build Android (armeabi-v7a) & Publish

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      app_id: pvr.jellyfin
      ANDROID_ARCH: arm
      ANDROID_CPU: armeabi-v7a
    steps:
      - name: Checkout addon repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.app_id }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and cache Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.app_id }}
          file: ${{ env.app_id }}/Dockerfile.android-build
          push: false
          load: true
          tags: kodi-android-builder:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set version
        id: set_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            # Read version from VERSION file
            VERSION=$(cat ${{ env.app_id }}/VERSION)
            echo "Read VERSION from file: $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Selected VERSION=$VERSION"

      - name: Checkout Kodi repository (for addon build)
        uses: actions/checkout@v4
        with:
          repository: xbmc/xbmc
          ref: Omega
          path: xbmc

      - name: Prepare addon for Kodi build system
        run: |
          mkdir -p xbmc/cmake/addons/addons/${{ env.app_id }}
          echo "${{ env.app_id }} file://$(pwd)/${{ env.app_id }}" > xbmc/cmake/addons/addons/${{ env.app_id }}/${{ env.app_id }}.txt

      - name: Build addon using Docker image
        run: |
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            -e ADDON_SRC_PREFIX=/workspace \
            -e OVERRIDE_BUILD_VERSION=${{ env.VERSION }} \
            kodi-android-builder:latest \
            bash -c "
              cd /workspace/xbmc &&
              echo 'addon.xml.in - before build:' &&
              head -5 /workspace/${{ env.app_id }}/addon.xml.in &&
              make -C tools/depends/target/binary-addons ADDONS='${{ env.app_id }}' \
                ADDON_SRC_PREFIX=/workspace \
                PREFIX=/opt/xbmc-depends \
                CROSS_COMPILING=yes
            "

      - name: Locate and prepare addon package
        run: |
          set -euo pipefail
          # Find the built addon zip
          ADDON_ZIP=$(find xbmc -name "${{ env.app_id }}-*.zip" -print -quit || true)
          if [ -z "$ADDON_ZIP" ]; then
            echo "Addon zip not found. Searching..." >&2
            find xbmc -name "*.zip" -type f >&2
            exit 1
          fi
          echo "Found addon package: $ADDON_ZIP"
          
          # Extract the zip to rename with our version
          TEMP_DIR=$(mktemp -d)
          unzip -q "$ADDON_ZIP" -d "$TEMP_DIR"
          
          echo "Original addon.xml version:"
          grep 'version=' "$TEMP_DIR/${{ env.app_id }}/addon.xml" | head -1
          
          # Update addon.xml with our VERSION
          sed -i 's/version="[^"]*"/version="'"${VERSION}"'"/' "$TEMP_DIR/${{ env.app_id }}/addon.xml"
          
          echo "Updated addon.xml version:"
          grep 'version=' "$TEMP_DIR/${{ env.app_id }}/addon.xml" | head -1
          
          # Repackage with our version number
          cd "$TEMP_DIR"
          zip -q -r "${{ github.workspace }}/${{ env.app_id }}-${VERSION}.zip" "${{ env.app_id }}"
          cd "${{ github.workspace }}"
          rm -rf "$TEMP_DIR"
          
          ls -lh "${{ github.workspace }}/${{ env.app_id }}-${VERSION}.zip"

      - name: Update repository with new addon version
        run: |
          set -euo pipefail
          cd ${{ env.app_id }}
          
          # Copy the repackaged addon to repository
          echo "Copying repackaged addon to repository..."
          cp "${{ github.workspace }}/${{ env.app_id }}-${VERSION}.zip" "repository/${{ env.app_id }}/"
          
          # Update addons.xml
          echo "Updating repository addons.xml..."
          cd repository
          python3 ../scripts/update_repo.py
          
          # Commit the updated repository files
          cd ..
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add repository/
          git commit -m "Update repository for version ${VERSION}" || echo "No repository changes to commit"
          git push || echo "Nothing to push"

      - name: Create repository package
        run: |
          set -euo pipefail
          cd ${{ env.app_id }}
          chmod +x scripts/package_repo.sh
          ./scripts/package_repo.sh "${VERSION}"
          mv "repository.jellyfin.pvr-${VERSION}.zip" "${{ github.workspace }}/"
          ls -lh "${{ github.workspace }}/repository.jellyfin.pvr-${VERSION}.zip"

      - name: Increment version for next build
        run: |
          cd ${{ env.app_id }}
          chmod +x scripts/increment_version.sh
          ./scripts/increment_version.sh
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION
          git commit -m "Bump version after successful build v${{ env.VERSION }}"
          git push

      - name: Create release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }} (Android armeabi-v7a)
          body: |
            Android build for Kodi Omega (armeabi-v7a)
            
            **Installation:**
            1. Install `repository.jellyfin.pvr-${{ env.VERSION }}.zip` in Kodi
            2. Install the addon from the repository
            
            Or install `pvr.jellyfin-${{ env.VERSION }}.zip` directly
          files: |
            pvr.jellyfin-${{ env.VERSION }}.zip
            repository.jellyfin.pvr-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
