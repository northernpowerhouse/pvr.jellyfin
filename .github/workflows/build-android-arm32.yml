name: Build Android (armeabi-v7a) & Publish

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    env:
      app_id: pvr.jellyfin
      NDK_VERSION: r26d
    steps:
      - name: Checkout addon repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.app_id }}

      - name: Set version
        id: set_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.${GITHUB_RUN_NUMBER}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Selected VERSION=$VERSION"

      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-11-jdk \
            unzip zip cmake build-essential wget \
            autoconf automake libtool pkg-config \
            git curl

      - name: Cache Android NDK
        id: ndk-cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/android-ndk-${{ env.NDK_VERSION }}
          key: ndk-${{ env.NDK_VERSION }}-${{ runner.os }}

      - name: Download Android NDK (if not cached)
        if: steps.ndk-cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          echo "Downloading Android NDK ${NDK_VERSION}..."
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip -q ndk.zip
          echo "Downloaded NDK to ${GITHUB_WORKSPACE}/android-ndk-${NDK_VERSION}"

      - name: Set NDK path
        run: echo "ANDROID_NDK_ROOT=${GITHUB_WORKSPACE}/android-ndk-${NDK_VERSION}" >> $GITHUB_ENV

      - name: Install JsonCpp
        run: |
          sudo apt-get install -y libjsoncpp-dev
          
      - name: Checkout Kodi headers (shallow)
        run: |
          # Clone Kodi dev-kit headers we need - sparse checkout for speed
          git clone --depth=1 --filter=blob:none --sparse https://github.com/xbmc/xbmc.git kodi
          cd kodi
          git sparse-checkout set xbmc/addons/kodi-dev-kit

      - name: Process addon.xml template
        run: |
          cd ${{ env.app_id }}
          # Create addon.xml from template
          sed "s/@ADDON_DEPENDS@/<import addon=\"xbmc.pvr\" version=\"8.2.0\"\/>/g" addon.xml.in | \
          sed "s/@PLATFORM@/android/g" | \
          sed "s/@LIBRARY_FILENAME@/pvr.jellyfin.so/g" > addon.xml

      - name: Configure addon directly for Android
        run: |
          set -euo pipefail
          cd ${{ env.app_id }}
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.ANDROID_NDK_ROOT }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=armeabi-v7a \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DKODI_INCLUDE_DIR=${{ github.workspace }}/kodi/xbmc/addons/kodi-dev-kit/include \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install

      - name: Build addon
        run: |
          cd ${{ env.app_id }}/build
          make -j$(nproc)

      - name: Install and package addon
        run: |
          set -euo pipefail
          cd ${{ env.app_id }}/build
          make install
          
          # Create addon package manually
          cd ${{ github.workspace }}/install
          
          # Find the installed addon directory
          ADDON_DIR=$(find . -type d -name "${{ env.app_id }}" -print -quit)
          if [ -z "$ADDON_DIR" ]; then
            echo "Addon directory not found in install path"
            ls -la
            exit 1
          fi
          
          # Create zip
          zip -r "${{ github.workspace }}/${{ env.app_id }}-${VERSION}.zip" "$ADDON_DIR"
          ls -lh "${{ github.workspace }}/${{ env.app_id }}-${VERSION}.zip"

      - name: Create repository package
        run: |
          set -euo pipefail
          cd ${{ env.app_id }}
          chmod +x scripts/package_repo.sh
          ./scripts/package_repo.sh "${VERSION}"
          mv "repository.jellyfin.pvr-${VERSION}.zip" "${{ github.workspace }}/"
          ls -lh "${{ github.workspace }}/repository.jellyfin.pvr-${VERSION}.zip"

      - name: Create release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }} (Android armeabi-v7a)
          body: |
            Android build for Kodi Omega (armeabi-v7a)
            
            **Installation:**
            1. Install `repository.jellyfin.pvr-${{ env.VERSION }}.zip` in Kodi
            2. Install the addon from the repository
            
            Or install `pvr.jellyfin-${{ env.VERSION }}.zip` directly
          files: |
            pvr.jellyfin-${{ env.VERSION }}.zip
            repository.jellyfin.pvr-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
